#!/bin/bash
# ============================================================================
# whisper - Wrapper para whisper.cpp (versiÃ³n nativa compilada)
# TranscripciÃ³n de audio a texto usando inteligencia artificial
# ============================================================================
# Generado automÃ¡ticamente por Ansible
# Modo: CompilaciÃ³n nativa (sin contenedor)
# ============================================================================

set -e

# === CONFIGURACIÃ“N ===
WHISPER_BASE="{{ whisper_base_dir }}"
WHISPER_MODELOS="{{ whisper_models_dir }}"
WHISPER_AUDIO="{{ whisper_audio_dir }}"
WHISPER_OUTPUT="{{ whisper_output_dir }}"
WHISPER_CLI="{{ whisper_source_dir }}/build/bin/whisper-cli"
WHISPER_SOURCE="{{ whisper_source_dir }}"
MODELO_DEFECTO="{{ whisper_default_model }}"

# Colores para la terminal
ROJO='\033[0;31m'
VERDE='\033[0;32m'
AMARILLO='\033[1;33m'
AZUL='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BLANCO='\033[1;37m'
NC='\033[0m' # Sin color

# === FUNCIONES DE UTILIDAD ===

mostrar_banner() {
    echo -e "${CYAN}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                                                             â•‘"
    echo "â•‘   â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—      â•‘"
    echo "â•‘   â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—     â•‘"
    echo "â•‘   â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•     â•‘"
    echo "â•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—     â•‘"
    echo "â•‘   â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘     â•‘"
    echo "â•‘    â•šâ•â•â•â•šâ•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•     â•‘"
    echo "â•‘                                                             â•‘"
    echo "â•‘           TranscripciÃ³n de Audio con IA ğŸ¤âœğŸ“               â•‘"
    echo "â•‘              (VersiÃ³n nativa compilada)                     â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

info() {
    echo -e "${AZUL}â„¹ï¸  $1${NC}"
}

exito() {
    echo -e "${VERDE}âœ… $1${NC}"
}

advertencia() {
    echo -e "${AMARILLO}âš ï¸  $1${NC}"
}

error() {
    echo -e "${ROJO}âŒ $1${NC}"
    exit 1
}

verificar_binario() {
    if [ ! -x "$WHISPER_CLI" ]; then
        error "El binario whisper-cli no existe o no es ejecutable: $WHISPER_CLI
        
Recompila con: cd $WHISPER_SOURCE && cmake --build build --config Release"
    fi
}

# === COMANDOS PRINCIPALES ===

mostrar_ayuda() {
    mostrar_banner
    echo -e "${BLANCO}USO:${NC}"
    echo "    whisper <comando> [opciones]"
    echo ""
    echo -e "${BLANCO}COMANDOS DISPONIBLES:${NC}"
    echo ""
    echo -e "  ${VERDE}transcribir${NC} <archivo>  Transcribir un archivo de audio"
    echo -e "  ${VERDE}modelos${NC}                Gestionar modelos de whisper"
    echo -e "  ${VERDE}idiomas${NC}                Listar idiomas soportados"
    echo -e "  ${VERDE}estado${NC}                 Verificar estado del sistema"
    echo -e "  ${VERDE}ayuda${NC}                  Mostrar esta ayuda"
    echo ""
    echo -e "${BLANCO}EJEMPLOS:${NC}"
    echo ""
    echo "  # Transcribir un archivo de audio"
    echo -e "  ${CYAN}whisper transcribir mi_audio.wav${NC}"
    echo ""
    echo "  # Transcribir especificando idioma espaÃ±ol"
    echo -e "  ${CYAN}whisper transcribir mi_audio.mp3 --idioma es${NC}"
    echo ""
    echo "  # Transcribir con modelo mÃ¡s grande (mÃ¡s preciso)"
    echo -e "  ${CYAN}whisper transcribir mi_audio.wav --modelo medium${NC}"
    echo ""
    echo "  # Descargar un modelo especÃ­fico"
    echo -e "  ${CYAN}whisper modelos descargar large${NC}"
    echo ""
    echo "  # Listar modelos disponibles"
    echo -e "  ${CYAN}whisper modelos listar${NC}"
    echo ""
    echo -e "${BLANCO}MODELOS DISPONIBLES:${NC}"
    echo "  tiny   - Muy rÃ¡pido, menor precisiÃ³n (~75MB)"
    echo "  base   - Equilibrado (por defecto) (~142MB)"
    echo "  small  - Buena precisiÃ³n (~466MB)"
    echo "  medium - Alta precisiÃ³n (~1.5GB)"
    echo "  large  - MÃ¡xima precisiÃ³n (~3GB)"
    echo ""
    echo -e "${BLANCO}DIRECTORIOS:${NC}"
    echo "  Modelos:        $WHISPER_MODELOS"
    echo "  Audio:          $WHISPER_AUDIO"
    echo "  Transcripciones: $WHISPER_OUTPUT"
    echo ""
}

listar_idiomas() {
    mostrar_banner
    echo -e "${BLANCO}IDIOMAS SOPORTADOS:${NC}"
    echo ""
    echo "  es - EspaÃ±ol        en - InglÃ©s         pt - PortuguÃ©s"
    echo "  fr - FrancÃ©s        de - AlemÃ¡n         it - Italiano"
    echo "  nl - NeerlandÃ©s     pl - Polaco         ru - Ruso"
    echo "  zh - Chino          ja - JaponÃ©s        ko - Coreano"
    echo "  ar - Ãrabe          hi - Hindi          tr - Turco"
    echo "  vi - Vietnamita     th - TailandÃ©s      el - Griego"
    echo "  cs - Checo          da - DanÃ©s          fi - FinlandÃ©s"
    echo "  hu - HÃºngaro        no - Noruego        sv - Sueco"
    echo "  uk - Ucraniano      ca - CatalÃ¡n        gl - Gallego"
    echo "  eu - Euskera"
    echo ""
    echo -e "${CYAN}Usa --idioma CÃ“DIGO para especificar el idioma${NC}"
    echo -e "Ejemplo: ${VERDE}whisper transcribir audio.wav --idioma es${NC}"
    echo ""
}

verificar_estado() {
    mostrar_banner
    echo -e "${BLANCO}ESTADO DEL SISTEMA:${NC}"
    echo ""
    
    # Verificar binario
    echo -n "  Binario whisper-cli: "
    if [ -x "$WHISPER_CLI" ]; then
        echo -e "${VERDE}âœ“ Disponible${NC}"
    else
        echo -e "${ROJO}âœ— No encontrado${NC}"
    fi
    
    # Verificar soporte AVX
    echo -n "  Soporte AVX: "
    if grep -q 'avx' /proc/cpuinfo 2>/dev/null; then
        echo -e "${VERDE}âœ“ SÃ­${NC}"
    else
        echo -e "${AMARILLO}âœ— No (compilado sin AVX)${NC}"
    fi
    
    # Verificar directorios
    echo ""
    echo -e "${BLANCO}DIRECTORIOS:${NC}"
    for dir in "$WHISPER_MODELOS" "$WHISPER_AUDIO" "$WHISPER_OUTPUT"; do
        echo -n "  $dir: "
        if [ -d "$dir" ]; then
            echo -e "${VERDE}âœ“${NC}"
        else
            echo -e "${ROJO}âœ—${NC}"
        fi
    done
    
    # Listar modelos instalados
    echo ""
    echo -e "${BLANCO}MODELOS INSTALADOS:${NC}"
    if [ -d "$WHISPER_MODELOS" ]; then
        modelos_encontrados=$(find "$WHISPER_MODELOS" -name "ggml-*.bin" 2>/dev/null)
        if [ -n "$modelos_encontrados" ]; then
            for modelo in $modelos_encontrados; do
                nombre=$(basename "$modelo" | sed 's/ggml-//' | sed 's/.bin//')
                tamano=$(du -h "$modelo" | cut -f1)
                echo -e "  ${VERDE}âœ“${NC} $nombre ($tamano)"
            done
        else
            echo -e "  ${AMARILLO}No hay modelos instalados${NC}"
            echo -e "  Ejecuta: ${CYAN}whisper modelos descargar base${NC}"
        fi
    fi
    echo ""
}

# === GESTIÃ“N DE MODELOS ===

gestionar_modelos() {
    local subcomando="${1:-listar}"
    shift 2>/dev/null || true
    
    case "$subcomando" in
        listar|lista|ls)
            listar_modelos
            ;;
        descargar|download|bajar)
            descargar_modelo "$@"
            ;;
        eliminar|borrar|rm)
            eliminar_modelo "$@"
            ;;
        *)
            echo -e "${BLANCO}USO:${NC} whisper modelos <subcomando>"
            echo ""
            echo -e "${BLANCO}SUBCOMANDOS:${NC}"
            echo "  listar           Listar modelos instalados y disponibles"
            echo "  descargar <nombre>  Descargar un modelo"
            echo "  eliminar <nombre>   Eliminar un modelo instalado"
            echo ""
            ;;
    esac
}

listar_modelos() {
    echo ""
    echo -e "${BLANCO}MODELOS DISPONIBLES:${NC}"
    echo ""
    
    modelos=("tiny" "tiny.en" "base" "base.en" "small" "small.en" "medium" "medium.en" "large-v1" "large-v2" "large-v3" "large-v3-turbo")
    
    for modelo in "${modelos[@]}"; do
        archivo="$WHISPER_MODELOS/ggml-${modelo}.bin"
        if [ -f "$archivo" ]; then
            tamano=$(du -h "$archivo" | cut -f1)
            echo -e "  ${VERDE}âœ“${NC} $modelo (instalado - $tamano)"
        else
            echo -e "  ${BLANCO}â—‹${NC} $modelo"
        fi
    done
    echo ""
    echo -e "Para descargar: ${CYAN}whisper modelos descargar <nombre>${NC}"
    echo ""
}

descargar_modelo() {
    local modelo="${1:-$MODELO_DEFECTO}"
    
    info "Descargando modelo '$modelo'..."
    info "Esto puede tardar varios minutos dependiendo de tu conexiÃ³n."
    echo ""
    
    # Usar el script de descarga del repositorio
    if [ -f "$WHISPER_SOURCE/models/download-ggml-model.sh" ]; then
        bash "$WHISPER_SOURCE/models/download-ggml-model.sh" "$modelo" "$WHISPER_MODELOS"
    else
        error "No se encontrÃ³ el script de descarga en $WHISPER_SOURCE/models/"
    fi
    
    if [ -f "$WHISPER_MODELOS/ggml-${modelo}.bin" ]; then
        exito "Modelo '$modelo' descargado correctamente"
    else
        error "Error al descargar el modelo '$modelo'"
    fi
}

eliminar_modelo() {
    local modelo="$1"
    
    if [ -z "$modelo" ]; then
        error "Especifica el nombre del modelo a eliminar"
    fi
    
    archivo="$WHISPER_MODELOS/ggml-${modelo}.bin"
    
    if [ -f "$archivo" ]; then
        echo -e "${AMARILLO}Â¿EstÃ¡s seguro de eliminar el modelo '$modelo'? [s/N]${NC}"
        read -r respuesta
        if [[ "$respuesta" =~ ^[Ss]$ ]]; then
            rm -f "$archivo"
            exito "Modelo '$modelo' eliminado"
        else
            info "OperaciÃ³n cancelada"
        fi
    else
        error "El modelo '$modelo' no estÃ¡ instalado"
    fi
}

# === TRANSCRIPCIÃ“N ===

transcribir() {
    local archivo_entrada=""
    local modelo="$MODELO_DEFECTO"
    local idioma=""
    local formato="txt"
    local archivo_salida=""
    local opciones_extra=""
    local traducir=false
    
    # Parsear argumentos
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --modelo|-m)
                modelo="$2"
                shift 2
                ;;
            --idioma|-l)
                idioma="$2"
                shift 2
                ;;
            --formato|-f)
                formato="$2"
                shift 2
                ;;
            --salida|-o)
                archivo_salida="$2"
                shift 2
                ;;
            --traducir|-t)
                traducir=true
                shift
                ;;
            --cpu|--no-gpu|-ng)
                opciones_extra="$opciones_extra --no-gpu"
                shift
                ;;
            --timestamps|-ts)
                opciones_extra="$opciones_extra --print-colors"
                shift
                ;;
            --ayuda|-h)
                mostrar_ayuda_transcribir
                return
                ;;
            -*)
                # Pasar opciones desconocidas directamente a whisper-cli
                opciones_extra="$opciones_extra $1"
                shift
                ;;
            *)
                if [ -z "$archivo_entrada" ]; then
                    archivo_entrada="$1"
                fi
                shift
                ;;
        esac
    done
    
    # Validaciones
    if [ -z "$archivo_entrada" ]; then
        error "Debes especificar un archivo de audio.
        
Uso: whisper transcribir <archivo> [opciones]

Ejemplo: whisper transcribir mi_audio.wav --idioma es"
    fi
    
    # Obtener ruta absoluta del archivo
    if [[ "$archivo_entrada" = /* ]]; then
        ruta_absoluta="$archivo_entrada"
    else
        ruta_absoluta="$(pwd)/$archivo_entrada"
    fi
    
    if [ ! -f "$ruta_absoluta" ]; then
        error "El archivo '$archivo_entrada' no existe"
    fi
    
    # Verificar modelo
    archivo_modelo="$WHISPER_MODELOS/ggml-${modelo}.bin"
    if [ ! -f "$archivo_modelo" ]; then
        advertencia "El modelo '$modelo' no estÃ¡ instalado"
        echo -e "${CYAN}Â¿Deseas descargarlo ahora? [S/n]${NC}"
        read -r respuesta
        if [[ ! "$respuesta" =~ ^[Nn]$ ]]; then
            descargar_modelo "$modelo"
        else
            error "Modelo no disponible. Usa 'whisper modelos listar' para ver los instalados."
        fi
    elif [ ! -r "$archivo_modelo" ]; then
        error "El modelo '$modelo' existe pero no es legible: $archivo_modelo"
    fi
    
    # Preparar nombre de salida
    nombre_base=$(basename "$archivo_entrada" | sed 's/\.[^.]*$//')
    if [ -z "$archivo_salida" ]; then
        archivo_salida="$WHISPER_OUTPUT/${nombre_base}"
    fi
    
    # Construir comando
    local cmd="$WHISPER_CLI"
    cmd="$cmd -m $archivo_modelo"
    cmd="$cmd -f $ruta_absoluta"
    
    if [ -n "$idioma" ]; then
        cmd="$cmd -l $idioma"
    fi
    
    if [ "$traducir" = true ]; then
        cmd="$cmd -tr"
    fi
    
    # AÃ±adir formato de salida
    case "$formato" in
        txt)
            cmd="$cmd -otxt"
            ;;
        srt)
            cmd="$cmd -osrt"
            ;;
        vtt)
            cmd="$cmd -ovtt"
            ;;
        json)
            cmd="$cmd -oj"
            ;;
        lrc)
            cmd="$cmd -olrc"
            ;;
    esac
    
    cmd="$cmd -of $archivo_salida $opciones_extra"
    
    mostrar_banner
    info "Transcribiendo: $(basename "$archivo_entrada")"
    info "Modelo: $modelo"
    [ -n "$idioma" ] && info "Idioma: $idioma"
    info "Formato de salida: $formato"
    echo ""
    info "Procesando... (esto puede tardar unos minutos)"
    echo ""
    
    verificar_binario
    
    # Ejecutar transcripciÃ³n
    eval $cmd
    
    echo ""
    
    # Verificar resultado
    extension="$formato"
    [ "$formato" = "json" ] && extension="json"
    
    if [ -f "${archivo_salida}.${extension}" ]; then
        exito "Â¡TranscripciÃ³n completada!"
        info "Archivo guardado en: ${archivo_salida}.${extension}"
        echo ""
        echo -e "${BLANCO}PRIMERAS LÃNEAS DE LA TRANSCRIPCIÃ“N:${NC}"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        head -20 "${archivo_salida}.${extension}"
        echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    else
        # Buscar cualquier archivo generado
        archivos_generados=$(find "$WHISPER_OUTPUT" -name "${nombre_base}.*" -newer "$ruta_absoluta" 2>/dev/null | head -5)
        if [ -n "$archivos_generados" ]; then
            exito "Â¡TranscripciÃ³n completada!"
            info "Archivos generados:"
            echo "$archivos_generados"
        else
            advertencia "La transcripciÃ³n se ejecutÃ³ pero no se encontrÃ³ el archivo de salida esperado"
            info "Revisa el directorio: $WHISPER_OUTPUT"
        fi
    fi
}

mostrar_ayuda_transcribir() {
    echo ""
    echo -e "${BLANCO}USO:${NC} whisper transcribir <archivo> [opciones]"
    echo ""
    echo -e "${BLANCO}OPCIONES:${NC}"
    echo "  --modelo, -m <nombre>    Modelo a usar (default: $MODELO_DEFECTO)"
    echo "  --idioma, -l <cÃ³digo>    Idioma del audio (ej: es, en, fr)"
    echo "  --formato, -f <tipo>     Formato de salida: txt, srt, vtt, json, lrc"
    echo "  --salida, -o <archivo>   Nombre del archivo de salida"
    echo "  --traducir, -t           Traducir al inglÃ©s"
    echo "  --cpu, --no-gpu          Usar solo CPU (desactivar GPU)"
    echo "  --timestamps, -ts        Mostrar marcas de tiempo con colores"
    echo "  --ayuda, -h              Mostrar esta ayuda"
    echo ""
    echo -e "${BLANCO}EJEMPLOS:${NC}"
    echo "  whisper transcribir entrevista.wav"
    echo "  whisper transcribir podcast.mp3 --idioma es --formato srt"
    echo "  whisper transcribir audio.wav --modelo large --traducir"
    echo ""
}

# === COMANDO PRINCIPAL ===

main() {
    local comando="${1:-ayuda}"
    shift 2>/dev/null || true
    
    case "$comando" in
        transcribir|t|trans)
            transcribir "$@"
            ;;
        modelos|modelo|m)
            gestionar_modelos "$@"
            ;;
        idiomas|idioma|i|langs)
            listar_idiomas
            ;;
        estado|status|s)
            verificar_estado
            ;;
        ayuda|help|h|-h|--help)
            mostrar_ayuda
            ;;
        version|v|-v|--version)
            echo "whisper wrapper v1.0 (nativo)"
            echo "Binario: $WHISPER_CLI"
            ;;
        *)
            # Si el primer argumento es un archivo, asumir transcripciÃ³n
            if [ -f "$comando" ] || [ -f "$(pwd)/$comando" ]; then
                transcribir "$comando" "$@"
            else
                error "Comando desconocido: $comando
                
Usa 'whisper ayuda' para ver los comandos disponibles."
            fi
            ;;
    esac
}

main "$@"
